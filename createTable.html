<!DOCTYPE html>
<html lang="en">



    <head>

        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>NIDM-Terms: Export Terms</title>
        
        
        <link rel="stylesheet" type="text/css" herf="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.0/css/bootstrap.css">
        <link rel="stylesheet" type="text/css" herf="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.18/css/bootstrap-select.min.css">
        <script src= "https://code.jquery.com/jquery-3.5.1.js"></script> 
        <script src="./js_lib/jquery.treeView.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/jsonld@1.0.0/dist/jsonld.min.js"></script>
        <script src="http://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.0/jquery.min.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.0/js/bootstrap.bundle.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.18/js/bootstrap-select.min.js"></script>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
        <script src='https://kit.fontawesome.com/a076d05399.js'></script>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

        <script src="https://cdn.jsdelivr.net/npm/jsonld@1.0.0/dist/jsonld.min.js"></script>

        <script src="https://cdn.jsdelivr.net/npm/danfojs@0.1.1/dist/index.min.js"></script>
        <script src="http://code.jquery.com/jquery-1.7.1.js" type="text/javascript"></script>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/jsonld/1.0.0/jsonld.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/jsonld@1.0.0/dist/jsonld.min.js"></script>
        <script src="https://unpkg.com/jsonld@1.0.0/dist/jsonld.min.js"></script> 

    </head>



    <body>

        <add key="webpages:Enabled" value="true" />


        <div class="about">
            <form action = "https://github.com/NIDM-Terms/terms" target="_blank">
                <button class= "github">Github <i class="fa fa-github" style="font-size:17px"></i>
                </button>
            </form>
            <form action = "https://scicrunch.org/nidm-terms/about/project" target="_blank">
               <button  class= "website">NIDM Website</button>
            </form>
            <form action = "http://nidm.nidash.org/" target="_blank">
                <button class = "nidmSpecs"> NIDM Specs</button>
            </form>
            <form action ="https://github.com/incf-nidash/PyNIDM" target= "_blank" >
                <button class= "pyNidm"> PyNIDM</a>
            </form>
            <form action ="https://sanuann.github.io/nidmterms-ui/#/annotate" target= "_blank" >
                <button class= "annoTool"> Annotation Tool</a>
            </form>
        </div>

        <header>
            <div class= "logo">
                <img src="img/nidm-terms_576163.png" width= "70" height="70">
            </div>
            <div class="inner">
                <h>NIDM-Terms</h>
            </div>
        </header>



        <div>
            <nav>
                <ul class= "menuUl"><center>
                    <li class= "menuLi">
                        <form action= "index.html">
                            <button class = "available_terms" type="submit">Available Terms</button>
                        </form>
                    </li>
                    <li class= "menuLi">
                        <form action= "addNewTerm.html">
                            <button class = "add_terms" type="submit">Suggest Terms</button>
                        </form>
                    </li>

                    <li class= "menuLi">
                        <form action="createTable.html">
                            <button class = "createTable">Export Terms</button>
                        </form>
                    </li>

                    <li class= "menuLi">
                        <form action= "addCommunity.html">
                            <button class = "add_community" type="submit">Add New Community</button>
                        </form>
                    </li>

                    <li class= "menuLi">
                        <form action="info.html">
                            <button class = "resources">About</button>
                        </form> 
                    </li>
                    <center><hr id="menuLine"></center>
                </center></ul>
            </nav>
        </div>



        <center><div>
            <div>
                
                <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
                <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.3/js/select2.min.js"></script>
                <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.3/css/select2.min.css" rel="stylesheet" />

                

                <div class="container mt-5">

                    <div>
                        <button class="btn" id="downloadBtn" onclick="getFile()"> Export </button>
                    </div>
                    <br><br>

                    <div id= "stepTwo">
                        <h2 id="stepTitles">Build Your File(s) <hr style="margin-top: 5px;"></h2>
                        <br><br>
                        <div class= "cont">
                            <div class="row">
                                    
                                <div class="col-md-6">
                                    <div id="format" class="form-group"> <label><h4>Select File Format *</h4></label> 
                                        <select class="form-control select2 select2-hidden-accessible" multiple="" data-placeholder="  select or search formats" style="width: 100%;" tabindex="-1" aria-hidden="true">     
                                            <option value="md">Markdown Table</option>
                                            <option value="json">JSON</option>
                                            <option value="jsonld">JSON-LD</option>
                                            <option value="csv">CSV</option>
                                            <option value="nq">N-Quads</option>
                                        </select></div> <!-- /.form-group -->
                                </div> <!-- /.col -->

                                <br><br><br><br>
                                
                                <div class="col-md-6">
                                    <div id="properties" class="form-group"> <label><h4>Select Term Properties *</h4></label>
                                        <select id = "addProperties" class="form-control select2 select2-hidden-accessible" multiple="" data-placeholder="  select or search term properties" style="width: 100%;" tabindex="-1" aria-hidden="true">
                                        </select> </div> <!-- /.form-group -->
                                </div> <!-- /.col -->
                                <div id = "prop">Click <a id = "here" href="https://github.com/NIDM-Terms/terms/blob/master/terms/README.md" target="_blank">here</a>  to view data element property descriptions</div>
                            </div>
                        </div>

                        <br><br><br><br><br>

                            <h2 id="stepTitles">Select Terms <hr style="margin-top: 5px;"></h2>

                            <div class="headerBrdr"><center>
                            </center></div>
                            <br><br>

                            <div class="headerBrdr"><center>
                                
                            </center></div>

                            <center><div id = "selection">
                                <div id="selectComunity">
                                    <h2 id="selectTitle">.</h2>
                                    <div id = "options"></div>
                                </div>
                                
                            </div></center>

                            <div id="changeBtn">
                                <button class="btn0" id="startBtn"> Add Terms </button>
                            </div>
                            <br><br><br><br><br><br><br>

                        <div class= "cont">

                            <br><br><br>

                            <div class="bidsTitle">
                                <div class= "search-box">
                                    
                                </div>
                                
                            </div>
                            
                            <div id="buttons"></div>
                            <br><br><br><br><br>

                            <div id="termsView"></div>

                            
                        </div>
                    </div>
                </div>
            
            </div>
        </div></center>

    </body>

    <footer>
        <div id="footer">
            <hr id= "bottomLine">
            <p><center>This project was supported by the National Institutes of Mental Health (NIMH) grant 1RF1MH120021</center></p>
        <div>
    </footer>


    <style id = "style">.treeview,
        .treeview ul {list-style-type:none;
        overflow:hidden;
        }
        .treeview li {
            text-indent:1%;
            margin-top:0.4em;
            padding:0.15em 0 0.5em 1.5em;
            line-height:22px;
            background-repeat:no-repeat;
            background-size:24px 24px;
            margin-right: 30px;
        }

    
        .treeview>li:hover {
            cursor:pointer; 
            overflow: hidden;
        }
    
        .treeview span:hover {background-color: rgba(246,246,246,0.7
        
        ); } 

        .terms{
            margin-left: -22px;
        }

        header{
            background-color: #52575e;
            height: 100px;
        }
    
        .about{
            color: #52575e;
            font-size: 12px;
            cursor: pointer;
            outline: none;
            font-weight: lighter;
        }

        .github{
            float: right;
            padding: 20px;
            margin-right: -10px;
            margin-top: -48px;
            color: #646464;
            font-size: 13px;
            width: 130px;
            height:50px;
            font-weight: lighter;
        }

        .github:hover{
            color: #32e17c;
            transition: 0.1s;
        }
        
        .website{
            float: right;
            margin-right: -30px;
            margin-top: -43px;
            color:#646464;
            font-size: 13px;
            width: 130px;
            height:50px;
            font-weight: lighter;
        }

        .website:hover{
            color: #32e17c;
            transition: 0.1s;
        }

        .nidmSpecs{
            float: right;
            margin-right: -20px;
            margin-top: -43px;
            color: #646464;
            font-size: 13px;
            width: 130px;
            height:50px;
            font-weight: lighter;
        }

        .nidmSpecs:hover{
            color: #32e17c;
            transition: 0.1s;
        }

        .pyNidm{
            float: right;
            margin-right: -30px;
            margin-top: -43px;
            color: #646464;
            font-size: 13px;
            width: 130px;
            height:50px;
            font-weight: lighter;
        }

        .pyNidm:hover{
            color: #32e17c;
            transition: 0.1s;
        }

        .annoTool{
            float: right;
            margin-right: -20px;
            color: #646464;
            font-size: 13px;
            width: 130px;
            height:50px;
            font-weight: lighter;
        }

        .annoTool:hover{
            color: #32e17c;
            transition: 0.1s;
        }

        .inner{
            margin: 40px;
            padding-top: 25px;
            padding-bottom: -10px;
            padding-left: 124px;
            font-weight:lighter;
            font-size: 40px;
            font-family: serif;
            text-transform: uppercase;
            color: white;
        }
        .logo{
            position: absolute;
            top: 55px;
            left: 60px;
        }

        header{
            width: 100%;
        }

        body {
            background-color: #ffffff;
        }

        .menuUl{
            width: auto;
            margin-top: 40px;
        }

        .menuLi{
            display: inline-block;
            padding: 20px 5px;
        }

        button{
            width: 235px;
            height: 60px;
            background-color: transparent;
            border: transparent;
            border-radius: 0px;
            font-size: 18px;
            font-weight:bold;
            cursor: pointer;
            outline: none;
        }

        .available_terms{
            color: #EA2027;
            
        }
        .available_terms:hover{
            border: 2px solid #EA2027;
            border-radius: 5px;
        }

        .add_terms{
            color: #EE5A24;
        }
        .add_terms:hover{
            border: 2px solid #EE5A24;
            border-radius: 5px;
        }
        
        .createTable{
            color: #f1842b;
            border: 2px solid #f1842b;
            border-radius: 5px;
        }

        .add_community{
            color: #F79F1F;
        }
        .add_community:hover{
            border: 2px solid #F79F1F;
            border-radius: 5px;
        }

        .resources{
            color: #FFC312;
        }
        .resources:hover{
            border: 2px solid #FFC312;
            border-radius: 5px;

        }

        #menuLine{
            height: 10px;
            background-image: linear-gradient(
                to right, 
                #EA2027, 
                #EE5A24, 
                #F79F1F, 
                #FFC312
                );
            margin-top: -23px;
            width: 1450px;
        }

        .container{
            width: 1050px;
            height: 170%;
            text-align: left;
            font-family:Arial, Helvetica, sans-serif;
            border: 1px solid #b3b3b3 ;
            border-radius: 0px;
            padding: 80px;
            padding-top: 80px;
            padding-right: -10px;
            margin-top: 50px;
            margin-bottom: 100px;
            background-color: #F7F7F7 ;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);

        }

        #stepTitles{
            font-size: 32px;
            color: #6e6d6d;
            font-weight: 200;
            margin-left: 55px;
            margin-right: 55px;
        }

        .bidsTitle{
            color: white;
            background-size: 100px;
            background-color: white;
            font-size: 12px;
            font-weight: normal;
            text-indent: 150px;
            margin-top: -17.10px;
            padding-left: 60px;
        }

        .search_bar{
            float: right;
            margin-top: 18px;
            margin-right: 35px;
            border: 1px solid #a5a4a4;
            height: 36px;
            width: 840px;
            border-radius: 4px;
            background-color: #ffffff;
            font-size: 18px;
            text-indent: 45px;
            outline: none;
            color: #52575e;
        } 

        #searchIcon{
            color: #909091;
            float: right;
            margin-top: 23px;
            margin-left: -260px;
            font-size: 0px;
        }

        .cont{
            margin-left: 70px;
            margin-right: 70px;
            margin-top: -20px;
        }

        .headerBrdr{
            font-size: 30px;
            color: #7e7e7e;
            font-weight: bold;
        }
    

        h4{
            color: #6d6d6d;
            font-weight:bold;
            font-size: 22px;
            font-weight: 400;
            text-indent: 3px;
            line-height: 20px;
            margin-bottom: 15px;
        }

        .statement{
            color:#7e7e7e;
            font-size: 14px;
            padding-top: 90px;
        }

        #startBtn{
            box-shadow:inset 0px 1px 0px 0px #ffffff;
            background:linear-gradient(to bottom, #f9f9f9 5%, #e9e9e9 100%);
            background-color:#f9f9f9;
            border-radius:6px;
            border:1px solid #dcdcdc;
            cursor:pointer;
            color:#707070;
            font-family:Arial;
            font-size:18px;
            padding:2px 13px;
            text-decoration:none;
            text-shadow:0px 1px 0px #ffffff;
            float: right;
            height: 50px;
            width: 235px;
            margin-top: 30px;
            margin-right: 55px;
        }
        #startBtn:hover {
            background:linear-gradient(to bottom, #e9e9e9 5%, #f9f9f9 100%);
            background-color:#e9e9e9;
        }
        #startBtn:active {
            position:relative;
            top:1px;
        }

        .btn{
            box-shadow:inset 0px 1px 0px 0px #caefab;
            background:linear-gradient(to bottom, #77d42a 5%, #5cb811 100%);
            background-color:#77d42a;
            border-radius:6px;
            border:1px solid #268a16;
            cursor:pointer;
            color:#306108;
            font-family:Arial;
            font-size:18px;
            font-weight:bold;
            padding:12px 40px;
            text-decoration:none;
            text-shadow:0px 1px 0px #aade7c;
            float: right;
            width: 180px;
            height: 54px;
            margin-right: 55px;
            margin-top: 0px;
        }
        .btn:hover {
            background:linear-gradient(to bottom, #5cb811 5%, #77d42a 100%);
            background-color:#5cb811;
        }
        .btn:active {
            position:relative;
            top:1px;
        }
        
        .btn1{
            background: none!important;
            border: none;
            padding: 10px!important;
            /*optional*/
            font-family: arial, sans-serif;
            font-size: 21px;
            font-weight: 600;
            /*input has OS specific font-family*/
            color: #2196F3;
            text-decoration: underline;
            cursor: pointer;
            margin-top: -20px;
            margin-left: -78px;
        }

        .btn2 {
            box-shadow:inset 0px 1px 0px 0px #ffffff;
            background:linear-gradient(to bottom, #f9f9f9 5%, #e9e9e9 100%);
            background-color:#f9f9f9;
            border-radius:6px;
            border:1px solid #dcdcdc;
            display:inline-block;
            cursor:pointer;
            color:#707070;
            font-family:Arial;
            font-size:18px;
            padding:2px 13px;
            text-decoration:none;
            text-shadow:0px 1px 0px #ffffff;
            height: 50px;
            width: 260px;
            margin-top: 50px;
            margin-left: 30px;
            
        }
        .btn2:hover {
            background:linear-gradient(to bottom, #e9e9e9 5%, #f9f9f9 100%);
            background-color:#e9e9e9;
        }
        .btn2:active {
            position:relative;
            top:1px;
        }


        .process{
            color:#7e7e7e;
            font-size: 18px;
            padding-bottom: 90px;
        }

        #prop{
            font-style: italic;
            padding-top: 5px;
            font-size: 14px;
            margin-left: 10px;
            color: darkgray;
        }

        #here{
            font-style: italic;
            padding-top: 15px;
            font-size: 14px;
            color: rgb(120, 162, 240);
        }
        #here:hover{
            color:rgb(51, 107, 211);
        }

        #bottomLine{
            height: 3px;
            background-image: linear-gradient(
                to right, 
                #EA2027, 
                #EE5A24, 
                #F79F1F, 
                #FFC312
                );
            width: 100%;
        }

        #footer{
            position: fixed;
            left: 0;
            bottom: 0;
            width: 100%;
            text-align: center;
            background-color: white;
        }

        .multi_select_box{
            width: 400px;
            margin: 80px auto;
        }

        .multi_select_box select{
            width: 100%;
        }

        .multi_select_box button{
            background-color: lightgray !important;
            color: #fff !important;
            padding: 15px 25px;
        }
        

        .form-control {
            border-radius: 0;
            box-shadow: none;
            border-color: #d2d6de
        }

        .select2-hidden-accessible {
            border: 0 !important;
            clip: rect(0 0 0 0) !important;
            height: 1px !important;
            margin: -1px !important;
            overflow: hidden !important;
            padding: 0 !important;
            position: absolute !important;
            width: 1px !important
        }

        .form-control {
            display: block;
            width: 100%;
            height: 34px;
            padding: 6px 12px;
            font-size: 14px;
            line-height: 1.42857143;
            color: #555;
            background-color: #fff;
            background-image: none;
            border: 1px solid #ccc;
            border-radius: 4px;
            -webkit-box-shadow: inset 0 1px 1px rgba(0, 0, 0, .075);
            box-shadow: inset 0 1px 1px rgba(0, 0, 0, .075);
            -webkit-transition: border-color ease-in-out .15s, -webkit-box-shadow ease-in-out .15s;
            -o-transition: border-color ease-in-out .15s, box-shadow ease-in-out .15s;
            transition: border-color ease-in-out .15s, box-shadow ease-in-out .15s
        }

        .select2-container--default .select2-selection--single,
        .select2-selection .select2-selection--single {
            border: 1px solid #d2d6de;
            border-radius: 0;
            padding: 6px 12px;
            height: 34px
        }

        .select2-container--default .select2-selection--single {
            background-color: #fff;
            border: 1px solid #aaa;
            border-radius: 4px;
        }

        .select2-container .select2-selection--single {
            box-sizing: border-box;
            cursor: pointer;
            display: block;
            height: 28px;
            user-select: none;
            -webkit-user-select: none
        }

        .select2-container .select2-selection--single .select2-selection__rendered {
            padding-right: 10px
        }

        .select2-container .select2-selection--single .select2-selection__rendered {
            padding-left: 0;
            padding-right: 0;
            height: auto;
            margin-top: -3px
        }

        .select2-container--default .select2-selection--single .select2-selection__rendered {
            color: #444;
            line-height: 28px
        }

        .select2-container--default .select2-selection--single,
        .select2-selection .select2-selection--single {
            border: 1px solid #d2d6de;
            border-radius: 0 !important;
            padding: 6px 12px;
            height: 40px !important
        }

        .select2-container--default .select2-selection--single .select2-selection__arrow {
            height: 26px;
            position: absolute;
            top: 6px !important;
            right: 1px;
            width: 20px
        }

        input + .des-tool-tip-text {
            display: none;
        }
        input:hover + .des-tool-tip-text {
            display: block;
            position: absolute;
            text-align:left;
            padding: 0.3em;
            width: 150px;
            bottom: 150%;
            font-size: 16px;
            background: #52575e81;
            color: rgb(238, 238, 238);
            border-radius: 3px;
        }
        input:hover + .des-tool-tip-text:after {
            content: "";
            position: absolute;
            border:1px solid #52575e67;
            left: 0%;
            top: 100%;
            width: 0; 
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-top: 10px solid #52575e67;
        }

        /* The container */
        .con {
            display: inline-block;
            position: relative;
            padding-left: 35px;
            margin-bottom: 22px;
            margin-left: 45px;
            cursor: pointer;
            font-size: 16px;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        /* Hide the browser's default checkbox */
        .con input {
            position: absolute;
            opacity: 0;
            cursor: pointer;
            height: 0;
            width: 0;
        }

        /* Create a custom checkbox */
        .checkmark {
            position: absolute;
            top: 0;
            left: 0;
            height: 22px;
            width: 22px;
            background-color: rgb(219, 217, 217);
        }

        /* On mouse-over, add a grey background color */
        .con:hover input ~ .checkmark {
            background-color: #ccc;
        }

        /* When the checkbox is checked, add a blue background #2196F3 */
        .con input:checked ~ .checkmark {
            background-color: #2196F3;
        }

        /* Create the checkmark/indicator (hidden when not checked) */
        .checkmark:after {
            content: "";
            position: absolute;
            display: none;
        }

        /* Show the checkmark when checked */
        .con input:checked ~ .checkmark:after {
            display: block;
        }

        /* Style the checkmark/indicator */
        .con .checkmark:after {
            left: 8px;
            top: 3px;
            width: 4px;
            height: 10px;
            border: solid white;
            border-width: 0 3px 3px 0;
            -webkit-transform: rotate(45deg);
            -ms-transform: rotate(45deg);
            transform: rotate(45deg);
        }

        #options{
            margin-top: -38px;
            color: rgb(85, 85, 85);
        }

        #selectTitle{
            text-indent: 10px;
            font-weight: normal;
            color:   rgb(240, 240, 240);
            font-size: 20px;
        }

        #selectComunity{
            background-color: rgb(240, 240, 240);
            padding-top: 15px;
            padding-bottom: 20px;
            width: 90%;
        }


    
    </style>

    <script>

        //List that contains url's of all of the selected communities
        var List = [];
        // List that contains all selected terms
        var selectedTerms = [];
        //variable to state is used to check whether all terms were selected given the value 1 
        //or if all terms were unselected giving it the value 0
        var state = "";
        //a list of properties that don't need to be displayed
        var dontDisplay = ['rdfs','xsd','nidm','skos','owl','prov','terms','responseOptions','@version','label','reproschema','DataElement','PersonalDataElement','CommonDataElement']

        //////////////////////////////////////////////////////////////////////////////////////////
        //fetch the NIDM-Terms Context file and save into a variable
        //////////////////////////////////////////////////////////////////////////////////////////
        var context = {};
        fetch('https://raw.githubusercontent.com/NIDM-Terms/terms/master/context/cde_context.jsonld')
        .then(function(res){
            return res.json(); 
        })
        .then(function(temp){
            console.log(1, temp)

            //Add properties available in the context file to select term properties

            var options = '';
            options += '<option value = "all">-- All Available Properties --</option>'
            //loop throught the context file and display all available properties in the "Select Term Properties" drop down menu
            for(const property in temp['@context']){
                if(dontDisplay.includes(property)){
                    console.log()
                }else{
                    options += '<option value = "'+property+'">'+property+'</option>';
                }
            }
            //asign temp to the global dictionary context
            context = temp
            //append the variable optionsto the html document
            $('#addProperties').append(options)
        })
        


        //////////////////////////////////////////////////////////////////////////////////////////
        //bootstrap dropdown list function
        //////////////////////////////////////////////////////////////////////////////////////////
        $(document).ready(function() {
            $('.select2').select2({
                closeOnSelect: false
            });

            
            //create a list that contains checked terms
            var checkedTerms = [];

            //Add options
            //Fetch 'https://raw.githubusercontent.com/NIDM-Terms/nidm-terms.github.io/master/availableCommunities.json' to get a list of the available communities in NIDM-Terms/terms
            fetch('https://raw.githubusercontent.com/NIDM-Terms/nidm-terms.github.io/master/availableCommunities.json')
            .then(function(res){
                return res.json(); 
            })

            //Create chackboxes with the available communities and create a list of their URLS and pass it
            .then(function(avCom){

                //create am array containing all the urls to pass to pass
                //var urlList = []

                html = ''

                for (const [key,value] of Object.entries(avCom)){
                    
                    //add checkboxes
                    html += '<label id = "'+value['label']+'" class="con">'+key;
                    html += '<input id = "'+value['label']+'" type="checkbox" class="comOptions " name="checkbox" value = "'+value['URL']+'" unchecked="checked">';
                    html += '<div class="des-tool-tip-text">'+value['Description']+'</div>'
                    html += '<span class="checkmark"></span>';
                    html += '</label>';

                    //add urls to urlList
                    //urlList.push(value['URL']);

                }

                $("#options").append(html);

                //return urlList

            })
            .then(function(){

                // fetch selected communities
                $("#startBtn").click(function(){
                    $("#startBtn").text("Refresh Term List");
                    var urlList = [];
                    $.each($("input[type='checkbox']:checked"), function(){
                        urlList.push($(this).val());
                    });
                    $('#stepTwo').focus();
                    List = urlList
                    fetchAll(urlList)
                });


                //function that takes a list of urls of raw github jsonld file fetch them, and add the data to the mainDict
                function fetchAll(urlList){

                    //Main dictionary that contains either all Terms available or filtered terms
                    var mainList = []
                    
                    //loop through each jsonld github raw file, fetch, and add terms to a list
                    for(var i = 0; i < urlList.length; i++){
                        fetch(urlList[i])
                        .then(function(resp){
                            return resp.json(); 
                        })
                        .then(function(data){
                            var temp = mainList.concat(data['terms'])
                            mainList = temp
                            //Call sortOnKeys first to sort the terms
                            sortOnKeys(mainList)
                        })
                    }  
                    
                }

                //This function sorts the terms in an alphabetical order
                function sortOnKeys(dict_data) {
                    var sorted = [];
                    //sort terms based on the label of the dictionary
                    dict_data.sort((a, b) => (a.label > b.label) ? 1 : (a.label === b.label) ? ((a.description > b.size) ? 1 : -1) : -1 );
                    //Add sorted terms to a list
                    for (var p in dict_data) {
                        sorted[sorted.length] = dict_data[p].label;
                    }
                    //sorted.sort();
                    //call Display function and pass the sorted list
                    display(dict_data)
                }

                function display(data){

                    //add search bar for select terms and add buttons for term slecetion
                    $('.selectionReq').html("")
                    $('.search-box').html("")
                    $('#buttons').html("")
                    var search = '';
                    var buttons = '';
                    search += '<input id= "searchBar" class="search_bar" type="text" name="box" placeholder = "Search Terms"><i id= "searchIcon" class="fa fa-search" style="font-size:24px"></i>';
                    buttons += '<button class="btn2" id="selectAll"> Select All Terms </button>'
                    buttons += '<button class="btn2" id="unselectAll"> Unselect All Terms </button>'
                    buttons += '<a href= "https://nidm-terms.github.io/index.html?" target = "_blank"><button class="btn2" id="unselectAll"> View Terms Properties </button></a>'
                    $('.search-box').append(search);
                    $('#buttons').append(buttons);

                    //Get search input and pass the search
                    const searchBar = document.getElementById("searchBar");

                    searchBar.addEventListener("keyup", (e) => {
                        console.log(e.target.value)
                        const searchString = e.target.value;

                        const searchedTerms = filterTerms(data, searchString);

                        if(isEmpty(searchedTerms)){
                            document.getElementById('termsView').innerHTML = ''
                            doc = '<div style= "color:rgb(85, 85, 85);font-size:24px;font-weight:bold;"> NO MATCHING TERMS HAVE BEEN FOUND... </div>'
                            $('#termsView').append(doc);
                            return;
                        }

                        displayTerms(searchedTerms)

                    });


                    displayTerms(data) 

                    //Function to display the terms in a treeview
                    function displayTerms(data) {

                        //Clear previous term display
                        document.getElementById('termsView').innerHTML = "";

                        var terms = '<br>'
                        //loop through the terms objects and display terms
                        for (var d = 0; d < data.length; d++) { // Each sub-entry

                            if(selectedTerms.length > 0){
                                    if( selectedTerms.includes(data[d].label)){
                                        terms += '<div style= "margin-top: -40px;">'
                                        terms += '<label style= "font-size: 19px; color:#666666;" id = "'+data[d].label+'" class="con"><b>' + data[d].label +'</b>';
                                        terms += '<h5 style = "color: #7e7e7e; margin-top: 5px; font-size:14px; font-weight: 100;">'+data[d].description+'</h5>'
                                        terms += '<input id = "'+data[d].label+'" type="checkbox" name="termsCheckbox" value="'+data[d].label+'" checked>';
                                        terms += '<span class="checkmark"></span>';
                                        terms += '</label>';
                                        terms += '</div>'   
                                        terms += '<br>'
                                    }
                                    else{
                                        terms += '<div style= "margin-top: -40px;">'
                                        terms += '<label style= "font-size: 19px; color:#666666;" id = "'+data[d].label+'" class="con"><b>' + data[d].label +'</b>';
                                        terms += '<h5 style = "color: #7e7e7e; margin-top: 5px; font-size:14px; font-weight: 100;">'+data[d].description+'</h5>'
                                        terms += '<input id = "'+data[d].label+'" type="checkbox" name="termsCheckbox" value="'+data[d].label+'">';
                                        terms += '<span class="checkmark"></span>';
                                        terms += '</label>';
                                        terms += '</div>'   
                                        terms += '<br>'
                                    }
                            }
                            else{
                                terms += '<div style= "margin-top: -40px;">'
                                terms += '<label style= "font-size: 19px; color:#666666;" id = "'+data[d].label+'" class="con"><b>' + data[d].label +'</b>';
                                terms += '<h5 style = "color: #7e7e7e; margin-top: 5px; font-size:14px; font-weight: 100;">'+data[d].description+'</h5>'
                                terms += '<input id = "'+data[d].label+'" type="checkbox" name="termsCheckbox" value="'+data[d].label+'">';
                                terms += '<span class="checkmark"></span>';
                                terms += '</label>';
                                terms += '</div>'   
                                terms += '<br>'
                            }
                            
                        }   
                        $('#termsView').append(terms);
                    }
                    
                    function selects(){
                        //if selected all button was pressed, add all terms to selected terms
                        for(var u=0; u<data.length; u++){
                            selectedTerms.push(data[u].label)
                        }
                        var ele=document.getElementsByName('termsCheckbox');  
                        for(var i=0; i<ele.length; i++){  
                            if(ele[i].type=='checkbox')  
                                ele[i].checked=true;  
                        }
                        //Get the values selected in the checkboxes
                        var checkboxElems = document.querySelectorAll("input[name='termsCheckbox']");
                        //create anempty list to add the check box values to it
                        //let tempList = [];
                        //loop through the checked elements and call displayCheck
                        for (var i = 0; i < checkboxElems.length; i++) {
                            checkboxElems[i].addEventListener("click", displayCheck);
                        }
                    }  
                    function deSelect(){ 
                        //assign an empty list to selectedTerms if all terms are unselected
                        selectedTerms = [] 
                        var ele=document.getElementsByName('termsCheckbox');  
                        for(var i=0; i<ele.length; i++){  
                            if(ele[i].type=='checkbox')  
                                ele[i].checked=false;  
                            
                        }
                        //Get the values selected in the checkboxes
                        var checkboxElems = document.querySelectorAll("input[name='termsCheckbox']");
                        //create anempty list to add the check box values to it
                        //let tempList = [];
                        //loop through the checked elements and call displayCheck
                        for (var i = 0; i < checkboxElems.length; i++) {
                            checkboxElems[i].addEventListener("click", displayCheck);
                        } 
                        
                    } 

                    // this function filters the data dictionary based on the input of the search bar
                    function filterTerms(data, searchedTerms){
                        
                        var termsDict = {};
                        var termsList = [];

                        for (var l = 0; l < data.length; l++){
                            $.each(data[l], function (key, value) {
                                //search on label and convert both the search and the label to lower case
                                if(key == 'label' & data[l].label.toLowerCase().includes(searchedTerms.toLowerCase())){
                                    termsDict = data[l] 
                                    termsList.push(termsDict)  
                                };                          
                            }); 
                        };
                        console.log(14, termsList)
                        return termsList
                        
                    };


                    // This function checks if the dictionary is empty
                    function isEmpty(obj) {                
                        for(var key in obj) {
                            if(obj.hasOwnProperty(key))
                                return false;
                        }
                        return true;
                    }

                    document.getElementById("selectAll").addEventListener("click", selects)
                    document.getElementById("unselectAll").addEventListener("click", deSelect)

                    //put all selected terms in a list
                    console.log("test checked items", state)


                    //Get the values selected in the checkboxes
                    var checkboxElems = document.querySelectorAll("input[name='termsCheckbox']");
                    //create anempty list to add the check box values to it
                    //let tempList = [];
                    //loop through the checked elements and call displayCheck
                    for (var i = 0; i < checkboxElems.length; i++) {
                        checkboxElems[i].addEventListener("click", displayCheck);
                    }

                    //This function checks which checkboxes were unchecked and passes a list of urls to the function fetchAll to display
                    function displayCheck(e) {
                        //create a list of the term catagories that were unchecked to filter out
                        if (!e.target.checked) {
                            for(i = 0; i < selectedTerms.length; i++){
                                if (selectedTerms[i] == e.target.value){
                                    delete selectedTerms[i]
                                }
                            }
                            selectedTerms = removeNull(selectedTerms)
                            console.log(selectedTerms.length)
                            
                            //list.push(e.target.value)
                        } else if (e.target.checked) {
                            //recheck after uncheck
                            selectedTerms.push(e.target.value)
                            selectedTerms = removeNull(selectedTerms)
                            console.log(13, selectedTerms)
                        }
                        //filters out
                        function removeNull(array) {
                            return array.filter(x => typeof x === 'string')
                        };
                    }

                }
            });
        });


        ///////////////////////////////////////////////////////////
        //function to fetch the single jsonld file
        ///////////////////////////////////////////////////////////
        function getFile(){
            //loop through the urlList and fetch each url and put the terms in a dictionary
            if(List.length != 0){
                var tempList = [];
                var temp = {};

                for(var i = 0; i < List.length; i++){
                    fetch(List[i])
                    .then(function(resp){
                        return resp.json(); 
                    })
                    .then(function(data){
                        //add the terms to a singular main list and sort
                        temp['@context'] = 'https://raw.githubusercontent.com/NIDM-Terms/terms/master/context/cde_context.jsonld';
                        var currData = tempList.concat(data['terms'])
                        tempList = currData
                        temp['terms'] = sortOnKeys(tempList)
                        
                        download(temp)
                    })
                }

                //This function sorts the terms in an alphabetical order
                function sortOnKeys(dict_data) {
                    var sorted = [];
                    //sort terms based on the label of the dictionary
                    dict_data.sort((a, b) => (a.label > b.label) ? 1 : (a.label === b.label) ? ((a.description > b.size) ? 1 : -1) : -1 );
                    //Add sorted terms to a list
                    for (var p in dict_data) {
                        sorted[sorted.length] = dict_data[p];
                    }
                    return sorted
                }
            }
        }

        var numCalls = 0;
        //This function gets the form of download the user chooses
        function download(jsonldData){
            numCalls++
            //only run if all communities' terms have been loaded
            if(numCalls===List.length){
                //get selected properties
                selectedProperties = $('#properties :selected').map((_,e) => e.value).get();
                console.log(55, selectedProperties)
                if(selectedProperties.length == 0){
                    alert('You must select at least one term property')
                }

                //get selected formats
                selectedFormats = $('#format :selected').map((_,e) => e.value).get();
                console.log(66, selectedFormats)
                arrayLength = selectedFormats.length;
                if(selectedFormats == 0){
                    alert('You must select at least one format')
                }

                else{
                    //call formats functions
                    for(var i = 0; i < arrayLength; i++){
                        if(selectedFormats[i] == 'md'){
                            mdTable(jsonldData,selectedProperties,selectedTerms)
                        };
                        if(selectedFormats[i] == 'json'){
                            getJson(jsonldData,selectedProperties,selectedTerms)
                        };
                        if(selectedFormats[i] == 'jsonld'){
                            getjsonld(jsonldData,selectedProperties,selectedTerms)
                        };
                        if(selectedFormats[i] == 'nq'){
                            rdf(jsonldData,selectedProperties,selectedTerms)
                        };
                        if(selectedFormats[i] == 'csv'){
                            csv(jsonldData,selectedProperties,selectedTerms)
                        }
                    }
                    // location.reload();
                }
            }
        };
        
        //This function exports a Mark down Table of the choosen terms
        function mdTable(jsonldData,selectedProperties,selectedTerms){

            rowDiv = '--------------';
            colDiv = '|'
            buildRows = "|          ";

            //get the selected properties
            selectedPropertiesLength = selectedProperties.length;
            for(p = 0; p < selectedPropertiesLength; p++){

                buildRows += "| " + selectedProperties[p];

            }

            buildRows += colDiv
            buildRows += "\n"
            buildRows += colDiv + rowDiv + colDiv

            for(l = 0; l < selectedPropertiesLength; l++){
                buildRows += rowDiv +colDiv
            } 
            
            buildRows += "\n"
            buildRows += colDiv

            for (var l in jsonldData['terms']) {                    
                //for every term selected get the selected properties of that term
                selectedTermsLength = selectedTerms.length;
                for(t = 0; t < selectedTermsLength; t++){
                    if(jsonldData.terms[l].label.toLowerCase() == selectedTerms[t].toLowerCase()){

                        buildRows += jsonldData.terms[l].label + colDiv 

                        for(tp = 0; tp < selectedPropertiesLength; tp++){
                            console.log(selectedProperties[tp])
                            var tempProp = selectedProperties[tp]
                            if( tempProp in jsonldData.terms[l]){
                                buildRows += jsonldData.terms[l][tempProp] + colDiv
                            } else{
                                buildRows += "         " + colDiv
                            }

                        }

                        buildRows += "\n"

                    }
                }
                

            }      
            //Download file
            downloadObjectAsJson(buildRows, "Terms_MD_Table")

            function downloadObjectAsJson(exportObj, exportName){
                var dataStr = "data:text/md;charset=utf-8," + encodeURIComponent(exportObj);
                var downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href",     dataStr);
                downloadAnchorNode.setAttribute("download", exportName + ".md");
                document.body.appendChild(downloadAnchorNode); // required for firefox
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
            }

        }

        //This function exports json formatted file 
        function getJson(jsonldData,selectedProperties,selectedTerms){
            jsonDict = {};

            for (var l in jsonldData['terms']) {
                //for every term selected get the selected properties of that term
                selectedTermsLength = selectedTerms.length;
                for(t = 0; t < selectedTermsLength; t++){
                    if(jsonldData.terms[l].label.toLowerCase() == selectedTerms[t].toLowerCase()){
                        temp = {};

                        //get the selected properties
                        selectedPropertiesLength = selectedProperties.length;
                        for(p = 0; p < selectedPropertiesLength; p++){

                            var tempProp = selectedProperties[p]

                            temp['associatedWith'] = jsonldData.terms[l]['associatedWith'];
                            if(selectedProperties.includes('all')){
                                for(u in jsonldData.terms[l]){
                                    temp[u] = jsonldData.terms[l][u]
                                    console.log(jsonldData.terms[l][u])
                                }
                            }
                            else{
                                if(tempProp in jsonldData.terms[l]){
                                    temp[tempProp] = jsonldData.terms[l][tempProp]
                                }
                            }
                        };

                        jsonDict[jsonldData.terms[l].label] = temp
                    }
                }
            }

            //Download file
            downloadObjectAsJson(jsonDict, "Terms")

            function downloadObjectAsJson(exportObj, exportName){
                var dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(exportObj));
                var downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href",     dataStr);
                downloadAnchorNode.setAttribute("download", exportName + ".json");
                document.body.appendChild(downloadAnchorNode); // required for firefox
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
            }
            
        }

        async function getjsonld(jsonldData,selectedProperties,selectedTerms){

            mainTemp = {};
            tempList =[];

            mainTemp['@context'] = 'https://raw.githubusercontent.com/NIDM-Terms/terms/master/context/cde_context.jsonld';
            mainTemp['@type'] = "nidm:TermsCollection";


            for (var l in jsonldData['terms']) {
                
                //for every term selected get the selected properties of that term
                selectedTermsLength = selectedTerms.length;
                for(t = 0; t < selectedTermsLength; t++){
                    if(jsonldData.terms[l].label.toLowerCase() == selectedTerms[t].toLowerCase()){
                        
                        temp = {};

                        //get the selected properties
                        selectedPropertiesLength = selectedProperties.length;
                        for(p = 0; p < selectedPropertiesLength; p++){

                            var tempProp = selectedProperties[p]
                            
                            if(selectedProperties.includes('all')){
                                for(u in jsonldData.terms[l]){
                                    temp[u] = jsonldData.terms[l][u]
                                    console.log(jsonldData.terms[l][u])
                                }
                            }
                            else{
                                temp[context['@context']['label']] = jsonldData.terms[l].label;
                                temp['@type'] = jsonldData.terms[l]['@type'];
                                temp[context['@context']['associatedWith']['@id']] = jsonldData.terms[l].associatedWith;
                                if(tempProp in jsonldData.terms[l]){
                                    temp[context['@context'][tempProp]] = jsonldData.terms[l][tempProp]
                                }
                            }
                        };

                        tempList.push(temp)

                    }
                }
            }
    
            mainTemp[context['@context']['terms']['@id']] = tempList

            //compact term dictionary
            const compacted = await jsonld.compact(mainTemp, 'https://raw.githubusercontent.com/NIDM-Terms/terms/master/context/cde_context.jsonld');
            
            //Download file
            downloadObjectAsJson(compacted, 'Terms')

            function downloadObjectAsJson(exportObj, exportName){
                var dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(exportObj));
                var downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href",     dataStr);
                downloadAnchorNode.setAttribute("download", exportName + ".jsonld");
                document.body.appendChild(downloadAnchorNode); // required for firefox
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
            }    
        }

        async function rdf(jsonldData,selectedProperties,selectedTerms){
            
            console.log('rdf is working')
            mainTemp = {};
            tempList =[];

            mainTemp['@context'] = 'https://raw.githubusercontent.com/NIDM-Terms/terms/master/context/cde_context.jsonld';
            mainTemp['@type'] = "nidm:TermsCollection";

            for (var l in jsonldData['terms']) {
                
                //for every term selected get the selected properties of that term
                selectedTermsLength = selectedTerms.length;
                for(t = 0; t < selectedTermsLength; t++){
                    if(jsonldData.terms[l].label.toLowerCase() == selectedTerms[t].toLowerCase()){
                        
                        temp = {};
                        
                        temp['@type'] = context['@context']['PersonalDataElement'];

                        //get the selected properties
                        selectedPropertiesLength = selectedProperties.length;
                        for(p = 0; p < selectedPropertiesLength; p++){

                            var tempProp = selectedProperties[p]

                            if(selectedProperties.includes('all')){
                                for(u in jsonldData.terms[l]){
                                    temp[u] = jsonldData.terms[l][u]
                                    console.log(jsonldData.terms[l][u])
                                }
                            }
                            else{
                                temp[context['@context']['label']] = jsonldData.terms[l].label;
                                temp['@type'] = jsonldData.terms[l]['@type'];
                                temp[context['@context']['associatedWith']['@id']] = jsonldData.terms[l].associatedWith;
                                if(tempProp in jsonldData.terms[l]){
                                    temp[context['@context'][tempProp]] = jsonldData.terms[l][tempProp]
                                }
                            }
                        };
                        tempList.push(temp)
                    }
                }
            }

            mainTemp[context['@context']['terms']['@id']] = tempList
            console.log(555, mainTemp)

            // serialize a document to N-Quads (RDF)
            const nquads = await jsonld.toRDF(mainTemp, {format: 'application/n-quads'});
            
            console.log(22, nquads) 
            
            //Download file
            downloadObjectAsJson(nquads, 'Terms')

            function downloadObjectAsJson(exportObj, exportName){
                var dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(exportObj));
                var downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href",     dataStr);
                downloadAnchorNode.setAttribute("download", exportName + ".nq");
                document.body.appendChild(downloadAnchorNode); // required for firefox
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
            }
        }

        function csv(jsonldData,selectedProperties,selectedTerms){
            console.log('csv is working')
            table = [];

            //get terms and properties
            for (var l in jsonldData['terms']) {

                //for every term selected get the selected properties of that term
                selectedTermsLength = selectedTerms.length;
                for(t = 0; t < selectedTermsLength; t++){
                    if(selectedTerms[t].toLowerCase() == jsonldData.terms[l].label.toLowerCase()){
                        temp = {};

                        //get the selected properties
                        selectedPropertiesLength = selectedProperties.length;
                        for(p = 0; p < selectedPropertiesLength; p++){
                            temp['label'] = jsonldData.terms[l].label

                            var tempProp = selectedProperties[p]

                            if(selectedProperties.includes('all')){
                                for(u in jsonldData.terms[l]){
                                    temp[u] = jsonldData.terms[l][u]
                                    console.log(jsonldData.terms[l][u])
                                }
                            }
                            else{
                                if(tempProp in jsonldData.terms[l]){
                                    temp[tempProp] = jsonldData.terms[l][tempProp]
                                }else {
                                temp[tempProp] = ''
                                }
                            }
                        };
                        //add temp dictionary to table to build the dataframe
                        table.push(temp);
                    }
                }
            }

            // Convert Object to JSON
            var jsonObject = JSON.stringify(table);

            //ConvertToCSV(jsonObject)

            function ConvertToCSV(objArray) {
                const array = typeof objArray !== 'object' ? JSON.parse(objArray) : objArray;
                let str = `${Object.keys(array[0]).map(value => `"${value}"`).join(",")}` + '\r\n';

                return array.reduce((str, next) => {
                    str += `${Object.values(next).map(value => `"${value}"`).join(",")}` + '\r\n';
                    return str;
                    }, str);
            };

            var blob = new Blob([ConvertToCSV(jsonObject)], { type: 'text/csv;charset=utf-8;' });
            var link = document.createElement("a");
            if (link.download !== undefined) { // feature detection
                // Browsers that support HTML5 download attribute
                var url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", "Terms");
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

            };

        }


    </script>      
     
</html>
